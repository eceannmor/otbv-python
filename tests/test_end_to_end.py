from src import octvencode
import numpy as np
import pytest
import os
import sys

class TestEndToEnd:
    
    def test(self):
        test_filename = "test.octv"
        sys.setrecursionlimit(5000)
        # this is a long line
        # render of this volume is saved in /images/end2end_test_volume.png
        input_data = "000080070000c00f0000801f0000801f0000001f0000801f0000801f0000800f000080070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000800f0000801f0000003f0000003e0000003f0000001f0000000f000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000003f0000003f0000007e0000007e0000003f0000000e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e0000007e000000fe000000fe000000fe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000003e0000007e000000fe010000ff010000ff010000ef000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000003f0000007f010000fe030000ff030080ff030080ef030000c70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000f0000001f0000001f010000ff030080ff070080ff0700c0ef0700c0c70700800100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000800f0000801f0000001f0000008e030080cf0f00c0ef0f00e0cf1f00e0870f00e00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080070000800f0000800f0000800f00000006030080830f00c0871f00e0873f00f0833f00f0031e00f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000c0070000c0070000c00f0000800700000000000000000f00c0011f00f0033f00f0037f00f8017e00f8003800700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080030000e0070000e0070000c007000080030000000000000000000000003e00f0017e00f801fe00fc01fc00fc00f8007c00600018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0030000e0030000e0030000c00300000000000000000000000000000000180060007c00f800fc00fc00fc01fe00f8017e00f0013e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000e0030000f0030000e0030000c001000000000000000000000000000000000000000070003800f8017c00f8037e00f0033f00e0033f00c0030e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000f0010000f0010000e00100000000000000000000000000000000000000000000000000000000e0013c00f0033f00f0073f00e0871f00c0870f00000707000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000000f8000000f8010000f8000000e0000000000000000000000000000000000000000000000000000000000000000000c0031f00e0871f00c0cf1f00c0df0f0000cf07000004010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000078000000f8000000f8000000780000000000000000000000000000000000000000000000000000000000000000000000000080030600808f0f0080df0f0080ff070000ff070000fe03000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380000007c000000fc000000fc000000380000000000000000000000000000000000000000000000000000000000000000000000000000000000008f030000df070000ff070000ff030000fe010000f80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000007e0000007c0000007c000000100000000000000000000000000000000000000000000000000000000000004000000060000000e0000000f0000000fe030000fe030000fe030000fc010000f8000000f0000000e00000006000000000000000000000000000000000000000000000000000000000000000000c0000003e0000003e0000003e0000003c000000000000000000000000000080000000c0000000c0000000e0000000e0000000e0000000f0000000f0000000f0000000f0000000fc010000fc010000fc010000f8000000f0000000f0000000f0000000e0000000e0000000c000000000000000000000000000000000000000000e0000001f0000003f0000003e0000001c0000c0010000c0010000c0010000e0010000e0010000e0010000e0010000f0010000f0010000f0010000f0010000f0010000f0010000f8030000f8010000f8010000f8000000f0000000f0010000f0010000f0010000e0010000e0010000c0010000c00100008001000000060000000f0000001f0000001f0000001e0000800d0000c0030000e0030000e0030000e0030000e0030000e0010000f0010000f0010000f0010000f0010000f0000000f0010000f0030000f0030000f0030000f0010000f0000000f0000000f0010000f0010000f0010000e0010000e0030000e0030000e0030000c0030000c0070000800f0000801f0000c01f0000c00f0000c0030000e0030000e0030000e0030000e0030000e0010000e0010000e0010000e0010000e0000000e0000000e0000000e0070000c0070000e0070000e0070000e00300000000000060000000e0000000e0000000e0010000e0010000e0030000e0030000e0030000c0030000c0070000c00f0000c00f0000c00f0000c0070000e0030000c0030000c0030000c0010000c0010000c0010000c0000000c0000000400000000000000000000000000f0000800f0000c00f0000c00f0000c00700008001000000000000000000000000000000000000c0000000c0010000c0010000c0030000c0030000c0030000c0070000c00f0000c00f0000c00f0000c0030000c0030000c00100008001000080000000000000000000000000000000000000000000000000000000000c0000001f0000801f0000801f0000800f000080070000000000000000000000000000000000000000000000000000000000000000000080010000c0010000c0030000c0070000c00f0000c01f0000c01f0000c00f0000c0030000000000000000000000000000000000000000000000000000000000000000000000000000003c0000003f0000003f0000001f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080070000800f0000801f0000003f0000003e0000001c0000000000000000000000000000000000000000000000000000000000000000000000380000007c0000007e0000003e0000003e0000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000003f0000003f0000007e0000003c0000007800000000000000000000000000000000000000000000000000000020000000f8000000fc0000007c0000007e0000003c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000003e0000007e0000007e0000007c000000f8000000e00000000000000000000000000000000000000000000000f0000000f8010000f8000000fc0000007c000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000007c000000fc000000fc000000f0010000e001000080000000000000000000000000000000c0010000f0010000f0010000f8010000f800000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000078000000f8000000f8010000f0030000e0030000c0030000000000000000000000000000c0030000e0030000f0030000f0030000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000f0000000f0010000e0070000e0070000c0070000800700000000000080070000c0070000e0070000e0070000e0030000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000e0030000c0070000c00f0000c00f0000800f000000060000800f0000c00f0000c00f0000c0070000c0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c003"
        byte_array = bytes.fromhex(input_data)
        bits = np.unpackbits(np.frombuffer(byte_array, dtype=np.uint8),
                                bitorder="little")
        volume = octvencode._reshape_volume_to_cubic(bits)
        assert volume.shape == (32,32,32)
        
        try:
            octvencode.save(volume, test_filename)
            assert os.path.isfile(test_filename)
            assert os.path.getsize(test_filename) > 100
            
            new_volume = octvencode.load(test_filename)
            assert volume.shape == new_volume.shape
            assert (volume == new_volume).all()
        except:
            raise
        finally:
            try:
                pass
                os.remove(test_filename)
            except:
                pass